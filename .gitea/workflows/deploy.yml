name: éƒ¨ç½²åšå®¢åˆ°W3å­˜å‚¨
on:
  push:
    branches:
      - main

# å®šä¹‰å·¥ä½œæµé˜¶æ®µ
jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åšå®¢
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç  - ä½¿ç”¨å†…ç½®çš„æ£€å‡ºæ“ä½œï¼Œä¸ä¾èµ–å¤–éƒ¨ actions
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4:https://github.com/actions/checkout
        # with:
        #   fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿ git å‘½ä»¤æ­£å¸¸å·¥ä½œ

      # æ„å»º Docker é•œåƒå¹¶è¿è¡Œ
      - name: æ„å»ºå¹¶è¿è¡Œ Docker é•œåƒ
        run: |
          echo "æ„å»º Docker é•œåƒ..."
          # ç¡®ä¿ Dockerfile ä¸­å·²æ·»åŠ  git å’Œ openssh
          docker build -t vitepress-blog .

          # åˆ›å»ºç›®å½•ä»¥ç¡®ä¿æŒ‚è½½ç‚¹å­˜åœ¨
          mkdir -p /share/CACHEDEV1_DATA/Container/gitea/deploy/blog/dist

          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å®¹å™¨
          echo "æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å®¹å™¨..."
          docker rm -f vitepress-builder || true

          # è¿è¡Œå®¹å™¨å¹¶æŒ‚è½½å·
          echo "è¿è¡Œå®¹å™¨å¹¶æ„å»ºåšå®¢..."
          docker run --name vitepress-builder \
            -v /share/CACHEDEV1_DATA/Container/gitea/deploy/blog/dist:/app/docs/.vitepress/dist \
            vitepress-blog

          # æ£€æŸ¥æ„å»ºç»“æœ
          echo "æ£€æŸ¥æ„å»ºç»“æœ..."
          ls -la /share/CACHEDEV1_DATA/Container/gitea/deploy/blog/dist || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"

      # å®‰è£… AWS CLI
      - name: å®‰è£…AWS CLI
        run: |
          echo "å®‰è£…AWS CLI..."
          apt-get update && apt-get install -y curl unzip

          # å°è¯•ä»å›½å†…é•œåƒä¸‹è½½ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å®˜æ–¹æº
          echo "ä¸‹è½½ AWS CLI å®‰è£…åŒ…..."
          curl "https://mirrors.huaweicloud.com/aws-cli/2.15.0/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" --connect-timeout 10 --retry 2 --retry-delay 2 || \
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" --connect-timeout 30 --retry 3 --retry-delay 2

          # è§£å‹å¹¶å®‰è£…
          echo "è§£å‹ AWS CLI å®‰è£…åŒ…..."
          unzip -q awscliv2.zip
          echo "å®‰è£… AWS CLI..."
          ./aws/install

          # æ¸…ç†å®‰è£…æ–‡ä»¶
          rm -rf awscliv2.zip aws

          # éªŒè¯å®‰è£…
          echo "éªŒè¯ AWS CLI å®‰è£…..."
          /usr/local/bin/aws --version || echo "AWS CLI å®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

      # é…ç½® AWS
      - name: é…ç½® AWS
        run: |
          echo "é…ç½® AWS å‡­è¯..."
          /usr/local/bin/aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          /usr/local/bin/aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          /usr/local/bin/aws configure set output json
          /usr/local/bin/aws configure set default.s3.addressing_style path
          /usr/local/bin/aws configure set default.s3.payload_signing_enabled true

      # ä¸Šä¼ åˆ° S3
      - name: ä¸Šä¼ åˆ° W3 å­˜å‚¨
        run: |
          echo "ä¸Šä¼ åˆ° W3 å­˜å‚¨..."
          /usr/local/bin/aws s3 cp /share/CACHEDEV1_DATA/Container/gitea/deploy/blog/dist s3://115-web/blog/ \
            --recursive \
            --cache-control "max-age=3600" \
            --endpoint-url http://home.yuanquanke.cn:35246

      # æ¸…ç†èµ„æº
      - name: æ¸…ç†èµ„æº
        if: always() # æ— è®ºå‰é¢æ­¥éª¤æˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½æ‰§è¡Œæ¸…ç†
        run: |
          echo "æ¸…ç†èµ„æº..."
          docker rm -f vitepress-builder || true
          rm -rf /share/CACHEDEV1_DATA/Container/gitea/deploy/blog/dist

      # éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success() # ä»…åœ¨æˆåŠŸæ—¶æ˜¾ç¤º
        run: |
          echo "âœ… åšå®¢å·²æˆåŠŸéƒ¨ç½²åˆ° W3 å­˜å‚¨ï¼"
          echo "ğŸ“Š éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: http://home.yuanquanke.cn:35246/115-web/blog/index.html"
