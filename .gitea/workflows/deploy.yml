name: éƒ¨ç½²åšå®¢åˆ°W3å­˜å‚¨
on:
  push:
    branches:
      - main

# å®šä¹‰å·¥ä½œæµé˜¶æ®µ
jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åšå®¢
    runs-on: ubuntu-latest
    # ä½¿ç”¨ Docker å®¹å™¨
    container:
      image: node:22-alpine
      options: --user root
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          echo "å®‰è£…ç³»ç»Ÿä¾èµ–..."
          apk update && apk add --no-cache git python3 py3-pip curl wget
          pip3 install awscli
          aws --version

      # å®‰è£… pnpm
      - name: å®‰è£… pnpm
        run: |
          npm install -g pnpm@latest --registry=https://registry.npmmirror.com
          pnpm config set registry https://registry.npmmirror.com
          pnpm --version

      # å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ç¼“å­˜æé«˜æ„å»ºé€Ÿåº¦ï¼‰
      - name: å®‰è£…ä¾èµ–
        run: |
          echo "å®‰è£…é¡¹ç›®ä¾èµ–..."
          pnpm install
          # å®‰è£… pagefind ç”¨äºç«™å†…æœç´¢
          pnpm add pagefind -D

      # æ„å»ºåšå®¢
      - name: æ„å»ºåšå®¢
        run: |
          echo "å¼€å§‹æ„å»ºåšå®¢..."
          pnpm build
          echo "åšå®¢æ„å»ºå®Œæˆï¼"
          ls -la docs/.vitepress/dist

      # é…ç½®ä¸Šä¼ è„šæœ¬
      - name: å‡†å¤‡ä¸Šä¼ è„šæœ¬
        run: |
          echo "å‡†å¤‡ä¸Šä¼ è„šæœ¬..."
          chmod +x ./upload-to-w3.sh
          
      # é…ç½® AWS å¹¶éƒ¨ç½²
      - name: é…ç½® AWS å¹¶éƒ¨ç½²
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          DIST_DIR: /github/workspace/docs/.vitepress/dist
          S3_BUCKET: 115-web
          S3_PREFIX: blog/
          S3_ENDPOINT: http://home.yuanquanke.cn:35246
        run: |
          echo "é…ç½® AWS å‡­è¯å¹¶å¼€å§‹éƒ¨ç½²..."
          # é…ç½® AWS CLI
          aws configure set default.s3.addressing_style path
          aws configure set default.s3.payload_signing_enabled true
          
          # æ‰§è¡Œä¸Šä¼ 
          echo "æ­£åœ¨éƒ¨ç½²åšå®¢åˆ° W3 å­˜å‚¨..."
          aws s3 sync "$DIST_DIR/" "s3://$S3_BUCKET/$S3_PREFIX" \
            --delete \
            --cache-control "max-age=3600" \
            --endpoint-url "$S3_ENDPOINT"

      # éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "âœ… åšå®¢å·²æˆåŠŸéƒ¨ç½²åˆ° W3 å­˜å‚¨ï¼"
          echo "ğŸ“Š éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: http://home.yuanquanke.cn:35246/115-web/blog/index.html"
