name: éƒ¨ç½²åšå®¢åˆ°W3å­˜å‚¨
on:
  push:
    branches:
      - main

# å®šä¹‰å·¥ä½œæµé˜¶æ®µ
jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åšå®¢
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç  - ä½¿ç”¨å†…ç½®çš„æ£€å‡ºæ“ä½œï¼Œä¸ä¾èµ–å¤–éƒ¨ actions
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4:https://github.com/actions/checkout
        # with:
        #   fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿ git å‘½ä»¤æ­£å¸¸å·¥ä½œ

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        run: |
          echo "è®¾ç½® Node.js ç¯å¢ƒ..."
          # æ£€æŸ¥ Node.js ç‰ˆæœ¬
          node --version
          npm --version

          # å®‰è£… pnpm
          echo "å®‰è£… pnpm..."
          npm install -g pnpm
          pnpm --version

      # å®‰è£…ä¾èµ–å¹¶æ„å»º
      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          echo "å®‰è£…é¡¹ç›®ä¾èµ–..."
          # ä½¿ç”¨å›½å†…é•œåƒæºåŠ é€Ÿå®‰è£…
          pnpm config set registry https://registry.npmmirror.com
          pnpm install

          echo "æ„å»ºåšå®¢..."
          pnpm build

          # æ£€æŸ¥æ„å»ºç»“æœ
          echo "æ£€æŸ¥æ„å»ºç»“æœ..."
          ls -la docs/.vitepress/dist || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"

      - name: éƒ¨ç½² nginx
        run: |
          echo "éƒ¨ç½² nginx docker..."
          # ç¡®ä¿å…ˆç§»é™¤æ—§å®¹å™¨ï¼Œæ— è®ºå…¶çŠ¶æ€å¦‚ä½•
          docker rm -f blog-web || true
          # æ‹‰å–æœ€æ–°çš„nginxé•œåƒ
          docker pull nginx:alpine
          # åˆ›å»ºæ–°å®¹å™¨
          docker run -d -p 17779:80 --name blog-web nginx:alpine
          # å¤åˆ¶æ„å»ºæ–‡ä»¶åˆ°å®¹å™¨
          docker cp docs/.vitepress/dist/. blog-web:/usr/share/nginx/html
          # é‡æ–°åŠ è½½nginxé…ç½®
          docker exec blog-web nginx -s reload

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… åšå®¢å·²æˆåŠŸéƒ¨ç½²åˆ°å†…ç½‘æœåŠ¡å™¨ï¼"
          echo "ğŸ“Š éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: http://192.168.2.102:17779"

          # æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
          DEPLOY_TIME=$(date "+%Y-%m-%d %H:%M:%S")

          # æ„å»ºæ›´ç¾è§‚çš„ Telegram æ¶ˆæ¯ï¼ˆä½¿ç”¨URLç¼–ç å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
          MESSAGE="*âœ… åšå®¢éƒ¨ç½²æˆåŠŸ\!*%0A%0AğŸ“Š *éƒ¨ç½²æ—¶é—´ï¼š* \`$DEPLOY_TIME\`%0A%0AğŸ”— *è®¿é—®é“¾æ¥ï¼š*%0Aâ–ªï¸ [å†…ç½‘åœ°å€](http://192.168.2.102:17779)%0Aâ–ªï¸ [å¤–ç½‘åœ°å€](http://blog.yuanquanke.cn:8888/)"

          # ä½¿ç”¨ Node.js å‘é€é€šçŸ¥
          node -e "
            const https = require('https');
            const url = 'https://proxy.yuanquanke.cn/https/api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage?chat_id=5679555666&parse_mode=MarkdownV2&text=${MESSAGE}';
            
            https.get(url, (res) => {
              let data = '';
              res.on('data', (chunk) => { data += chunk; });
              res.on('end', () => {
                console.log('Telegram é€šçŸ¥å·²å‘é€');
                console.log(data);
              });
            }).on('error', (err) => {
              console.error('å‘é€ Telegram é€šçŸ¥å¤±è´¥:', err.message);
            });
          "
