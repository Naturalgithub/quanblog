name: éƒ¨ç½²åšå®¢åˆ°W3å­˜å‚¨
on:
  push:
    branches:
      - main

# å®šä¹‰å·¥ä½œæµé˜¶æ®µ
jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åšå®¢
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç  - ä½¿ç”¨å†…ç½®çš„æ£€å‡ºæ“ä½œï¼Œä¸ä¾èµ–å¤–éƒ¨ actions
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4:https://github.com/actions/checkout
        # with:
        #   fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿ git å‘½ä»¤æ­£å¸¸å·¥ä½œ

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        run: |
          echo "è®¾ç½® Node.js ç¯å¢ƒ..."
          # æ£€æŸ¥ Node.js ç‰ˆæœ¬
          node --version
          npm --version

          # å®‰è£… pnpm
          echo "å®‰è£… pnpm..."
          npm install -g pnpm
          pnpm --version

      # å®‰è£…ä¾èµ–å¹¶æ„å»º
      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          echo "å®‰è£…é¡¹ç›®ä¾èµ–..."
          # ä½¿ç”¨å›½å†…é•œåƒæºåŠ é€Ÿå®‰è£…
          pnpm config set registry https://registry.npmmirror.com
          pnpm install

          echo "æ„å»ºåšå®¢..."
          pnpm build

          # æ£€æŸ¥æ„å»ºç»“æœ
          echo "æ£€æŸ¥æ„å»ºç»“æœ..."
          ls -la docs/.vitepress/dist || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"

      - name: éƒ¨ç½² nginx
        run: |
          echo "éƒ¨ç½² nginx docker..."
          docker pull nginx:alpine
          docker stop blog-web || true
          docker rmi blog-web || true
          docker run -d -p 17779:80 --name blog-web nginx:alpine
          docker cp docs/.vitepress/dist blog-web:/usr/share/nginx/html
          docker exec blog-web nginx -s reload

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… åšå®¢å·²æˆåŠŸéƒ¨ç½²åˆ° W3 å­˜å‚¨ï¼"
          echo "ğŸ“Š éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: https://blog.yuanquanke.cn:8888/"
