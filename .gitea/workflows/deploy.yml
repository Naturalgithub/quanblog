name: éƒ¨ç½²åšå®¢åˆ°W3å­˜å‚¨
on:
  push:
    branches:
      - main

# å®šä¹‰å·¥ä½œæµé˜¶æ®µ
jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åšå®¢
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç  - ä½¿ç”¨å†…ç½®çš„æ£€å‡ºæ“ä½œï¼Œä¸ä¾èµ–å¤–éƒ¨ actions v4:https://ghproxy.net/https://github.com/actions/checkout
      - name: æ£€å‡ºä»£ç 
        uses: https://gitea.com/actions/checkout@v4
        # with:
        #   fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿ git å‘½ä»¤æ­£å¸¸å·¥ä½œ

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        run: |
          echo "è®¾ç½® Node.js ç¯å¢ƒ..."
          # æ£€æŸ¥ Node.js ç‰ˆæœ¬
          node --version
          npm --version

          # å®‰è£… pnpm
          echo "å®‰è£… pnpm..."
          npm install -g pnpm

          # é…ç½®npmå’Œpnpmä½¿ç”¨æ·˜å®é•œåƒ
          echo "é…ç½®npmå’Œpnpmé•œåƒæº..."
          npm config set registry https://registry.npmmirror.com
          pnpm config set registry https://registry.npmmirror.com

      # å®‰è£…ä¾èµ–å¹¶æ„å»º
      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          echo "å®‰è£…é¡¹ç›®ä¾èµ–..."
          # ä½¿ç”¨å›½å†…é•œåƒæºåŠ é€Ÿå®‰è£…
          pnpm config set registry https://registry.npmmirror.com
          pnpm install

          echo "æ„å»ºåšå®¢..."
          pnpm build

          # æ£€æŸ¥æ„å»ºç»“æœ
          echo "æ£€æŸ¥æ„å»ºç»“æœ..."
          ls -la docs/.vitepress/dist || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"

      - name: éƒ¨ç½² nginx
        run: |
          echo "éƒ¨ç½² nginx docker..."
          # ç¡®ä¿å…ˆç§»é™¤æ—§å®¹å™¨ï¼Œæ— è®ºå…¶çŠ¶æ€å¦‚ä½•
          docker rm -f blog-web || true
          # æ‹‰å–æœ€æ–°çš„nginxé•œåƒ
          docker pull nginx:alpine
          # åˆ›å»ºæ–°å®¹å™¨
          docker run -d -p 17779:80 --name blog-web nginx:alpine
          # å¤åˆ¶æ„å»ºæ–‡ä»¶åˆ°å®¹å™¨
          docker cp docs/.vitepress/dist/. blog-web:/usr/share/nginx/html
          # é‡æ–°åŠ è½½nginxé…ç½®
          docker exec blog-web nginx -s reload

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… åšå®¢å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼"
          echo "ğŸ“Š éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: http://192.168.2.102:17779"

          python3 -c '
          import urllib.request
          import urllib.parse
          import json
          import os
          import datetime

          deploy_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

          message = "âœ… *åšå®¢éƒ¨ç½²æˆåŠŸ*ï¼\n\nğŸ“Š *éƒ¨ç½²æ—¶é—´*ï¼š " + deploy_time + "\n\nğŸ”— *è®¿é—®é“¾æ¥*ï¼š\nâ–ªï¸ [å†…ç½‘åœ°å€](http://192.168.2.102:17779)\nâ–ªï¸ [å¤–ç½‘åœ°å€](https://blog.yuanquanke.cn:8888)"

          token = "${{ secrets.TELEGRAM_BOT_TOKEN }}"
          chat_id = "5679555666"
          url = "https://proxy.yuanquanke.cn/https/api.telegram.org/bot" + token + "/sendMessage"

          data = {
              "chat_id": chat_id,
              "text": message,
              "parse_mode":"MarkdownV2"
          }
          encoded_data = urllib.parse.urlencode(data).encode("utf-8")

          try:
              req = urllib.request.Request(url, data=encoded_data, method="POST")
              req.add_header("Content-Type", "application/x-www-form-urlencoded")
              with urllib.request.urlopen(req) as response:
                  result = json.loads(response.read().decode("utf-8"))
                  print("Telegram é€šçŸ¥å·²å‘é€")
                  if not result.get("ok"):
                      print("APIè¿”å›é”™è¯¯:", result)
          except Exception as e:
              print(f"å‘é€ Telegram é€šçŸ¥å¤±è´¥: {e}")
              exit(1)
          '
