name: 部署博客到W3存储
on:
  push:
    branches:
      - main

# 定义工作流阶段
jobs:
  build-and-deploy:
    name: 构建并部署博客
    runs-on: ubuntu-latest
    steps:
      # 检出代码 - 使用内置的检出操作，不依赖外部 actions
      - name: 检出代码
        uses: actions/checkout@v4:https://github.com/actions/checkout
        with:
          fetch-depth: 0 # 获取完整历史以便 git 命令正常工作

      # 设置 Node.js 环境
      - name: 设置 Node.js 环境
        run: |
          echo "设置 Node.js 环境..."
          # 检查 Node.js 版本
          node --version
          npm --version

          # 安装 pnpm
          echo "安装 pnpm..."
          npm install -g pnpm
          pnpm --version

      # 安装依赖并构建
      - name: 安装依赖并构建
        run: |
          echo "安装项目依赖..."
          # 使用国内镜像源加速安装
          pnpm config set registry https://registry.npmmirror.com
          pnpm install

          echo "构建博客..."
          pnpm build

          # 检查构建结果
          echo "检查构建结果..."
          ls -la docs/.vitepress/dist || echo "构建目录不存在"

      - name: 安装AWS CLI
        run: |
          echo "安装AWS CLI..."
          apt-get update && apt-get install -y curl unzip
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" --connect-timeout 30 --retry 3 || echo "下载失败，但继续执行"
          unzip -q awscliv2.zip || echo "解压失败，但继续执行"
          ./aws/install || echo "安装失败，但继续执行"
          rm -rf awscliv2.zip aws
          which aws || echo "AWS CLI未找到"

      - name: 配置AWS
        run: |
          echo "配置AWS凭证..."
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set output json
          aws configure set default.s3.addressing_style path
          aws configure set default.s3.payload_signing_enabled true

      - name: 上传到W3存储
        run: |
          echo "上传到W3存储..."
          aws s3 sync docs/.vitepress/dist s3://115-web/blog/ --recursive --cache-control "max-age=3600" --endpoint-url http://home.yuanquanke.cn:35246

      # 清理资源
      # - name: 清理资源
      #   if: always() # 无论前面步骤成功或失败，都执行清理
      #   run: |
      #     echo "清理资源..."
      #     rm -rf $WORKSPACE_DIR/docs/.vitepress/dist

      # 部署完成通知
      - name: 部署完成通知
        if: success() # 仅在成功时显示
        run: |
          echo "✅ 博客已成功部署到 W3 存储！"
          echo "📊 部署时间: $(date)"
          echo "🌐 访问地址: http://home.yuanquanke.cn:35246/115-web/blog/index.html"
