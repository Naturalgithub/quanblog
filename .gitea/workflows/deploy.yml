name: éƒ¨ç½²åšå®¢åˆ°W3å­˜å‚¨
on:
  push:
    branches:
      - main

# å®šä¹‰å·¥ä½œæµé˜¶æ®µ
jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åšå®¢
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç  - ä½¿ç”¨å†…ç½®çš„æ£€å‡ºæ“ä½œï¼Œä¸ä¾èµ–å¤–éƒ¨ actions v4:https://ghproxy.net/https://github.com/actions/checkout
      - name: æ£€å‡ºä»£ç 
        uses: https://gitea.com/actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿ git å‘½ä»¤æ­£å¸¸å·¥ä½œ

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        run: |
          echo "è®¾ç½® Node.js ç¯å¢ƒ..."
          # æ£€æŸ¥ Node.js ç‰ˆæœ¬
          node --version
          npm --version

          # å®‰è£… pnpm
          echo "å®‰è£… pnpm..."
          npm install -g pnpm

          # ç½‘ç»œè¿é€šæ€§æ£€æŸ¥
          echo "æ£€æŸ¥ç½‘ç»œè¿é€šæ€§..."
          curl -I --connect-timeout 10 --max-time 30 https://registry.npmmirror.com/ || echo "æ·˜å®é•œåƒè¿æ¥å¤±è´¥"
          curl -I --connect-timeout 10 --max-time 30 https://registry.npmjs.org/ || echo "å®˜æ–¹é•œåƒè¿æ¥å¤±è´¥"

          # é…ç½®npmå’Œpnpmä½¿ç”¨æ·˜å®é•œåƒï¼Œæ·»åŠ è¶…æ—¶å’Œé‡è¯•å‚æ•°
          echo "é…ç½®npmå’Œpnpmé•œåƒæº..."
          npm config set registry https://registry.npmmirror.com
          npm config set timeout 300000
          npm config set fetch-retries 5
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000

          pnpm config set registry https://registry.npmmirror.com
          pnpm config set network-timeout 300000
          pnpm config set fetch-retries 5
          pnpm config set fetch-retry-mintimeout 20000
          pnpm config set fetch-retry-maxtimeout 120000

      # å®‰è£…ä¾èµ–å¹¶æ„å»º
      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          echo "å®‰è£…é¡¹ç›®ä¾èµ–..."

          # å®šä¹‰é‡è¯•å‡½æ•°
          retry_install() {
            local registry=$1
            local registry_name=$2
            echo "å°è¯•ä½¿ç”¨ $registry_name å®‰è£…ä¾èµ–..."
            
            pnpm config set registry $registry
            npm config set registry $registry
            
            # æ¸…ç†ç¼“å­˜
            pnpm store prune || true
            
            # å°è¯•å®‰è£…
            if pnpm install --no-frozen-lockfile --network-timeout 3000 --fetch-retries 5; then
              echo "$registry_name å®‰è£…æˆåŠŸï¼"
              return 0
            else
              echo "$registry_name å®‰è£…å¤±è´¥"
              return 1
            fi
          }

          # æŒ‰ä¼˜å…ˆçº§å°è¯•ä¸åŒé•œåƒæº
          if ! retry_install "https://registry.npmmirror.com" "æ·˜å®é•œåƒ"; then
            echo "æ·˜å®é•œåƒå¤±è´¥ï¼Œå°è¯•å®˜æ–¹é•œåƒ..."
            if ! retry_install "https://registry.npmjs.org" "å®˜æ–¹é•œåƒ"; then
              echo "å®˜æ–¹é•œåƒå¤±è´¥ï¼Œå°è¯•è…¾è®¯äº‘é•œåƒ..."
              if ! retry_install "https://mirrors.cloud.tencent.com/npm/" "è…¾è®¯äº‘é•œåƒ"; then
                echo "æ‰€æœ‰é•œåƒæºéƒ½å¤±è´¥ï¼Œæœ€åå°è¯•åä¸ºäº‘é•œåƒ..."
                if ! retry_install "https://repo.huaweicloud.com/repository/npm/" "åä¸ºäº‘é•œåƒ"; then
                  echo "âŒ æ‰€æœ‰é•œåƒæºéƒ½æ— æ³•ä½¿ç”¨ï¼Œä¾èµ–å®‰è£…å¤±è´¥"
                  exit 1
                fi
              fi
            fi
          fi

          echo "æ„å»ºåšå®¢..."
          # ä½¿ç”¨æ­£ç¡®çš„æ„å»ºå‘½ä»¤
          pnpm run build

          # æ£€æŸ¥æ„å»ºç»“æœ
          echo "æ£€æŸ¥æ„å»ºç»“æœ..."
          ls -la docs/.vitepress/dist || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"

      - name: éƒ¨ç½² nginx
        run: |
          echo "éƒ¨ç½² nginx docker..."
          # ç¡®ä¿å…ˆç§»é™¤æ—§å®¹å™¨ï¼Œæ— è®ºå…¶çŠ¶æ€å¦‚ä½•
          docker rm -f blog-web || true
          # æ‹‰å–æœ€æ–°çš„nginxé•œåƒ
          docker pull docker.m.daocloud.io/nginx:alpine
          # åˆ›å»ºæ–°å®¹å™¨
          docker run -d -p 17779:80 --name blog-web nginx:alpine
          # å¤åˆ¶æ„å»ºæ–‡ä»¶åˆ°å®¹å™¨
          docker cp docs/.vitepress/dist/. blog-web:/usr/share/nginx/html
          # é‡æ–°åŠ è½½nginxé…ç½®
          docker exec blog-web nginx -s reload

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… åšå®¢å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼"
          echo "ğŸ“Š éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: http://192.168.2.102:17779"

          python3 -c '
          import urllib.request
          import urllib.parse
          import json
          import os
          import datetime

          deploy_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

          message = "âœ… *åšå®¢éƒ¨ç½²æˆåŠŸ*ï¼\n\nğŸ“Š *éƒ¨ç½²æ—¶é—´*ï¼š " + deploy_time + "\n\nğŸ”— *è®¿é—®é“¾æ¥*ï¼š\nâ–ªï¸ [å†…ç½‘åœ°å€](http://192.168.2.102:17779)\nâ–ªï¸ [å¤–ç½‘åœ°å€](https://blog.yuanquanke.cn:8888)"

          token = "${{ secrets.TELEGRAM_BOT_TOKEN }}"
          chat_id = "5679555666"
          url = "https://proxy.yuanquanke.cn/https/api.telegram.org/bot" + token + "/sendMessage"

          data = {
              "chat_id": chat_id,
              "text": message,
              "parse_mode": "Markdown"
          }
          encoded_data = json.dumps(data).encode("utf-8")

          try:
              req = urllib.request.Request(url, data=encoded_data, method="POST")
              req.add_header("Content-Type", "application/json")
              with urllib.request.urlopen(req) as response:
                  result = json.loads(response.read().decode("utf-8"))
                  print("Telegram é€šçŸ¥å·²å‘é€")
                  if not result.get("ok"):
                      print("APIè¿”å›é”™è¯¯:", result)
          except Exception as e:
              print(f"å‘é€ Telegram é€šçŸ¥å¤±è´¥: {e}")
              exit(1)
          '
      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ æ³‰çš„åšå®¢éƒ¨ç½²å¤±è´¥ï¼"
          echo "ğŸ“Š éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: https://blog.yuanquanke.cn:8888/"
          python3 -c '
          import urllib.request
          import urllib.parse
          import json
          import os
          import datetime

          deploy_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

          message = "âŒ *åšå®¢éƒ¨ç½²å¤±è´¥*ï¼\n\nğŸ“Š *éƒ¨ç½²æ—¶é—´*ï¼š " + deploy_time + "\n\nğŸ”— *è®¿é—®é“¾æ¥*ï¼š\nâ–ªï¸ [å†…ç½‘åœ°å€](http://192.168.2.102:17779)\nâ–ªï¸ [å¤–ç½‘åœ°å€](https://blog.yuanquanke.cn:8888) \nâ–ªï¸ [æµæ°´çº¿åœ°å€](https://gitea.home.yuanquanke.cn:8888/yuanquanke/quange-blog/actions)"

          token = "${{ secrets.TELEGRAM_BOT_TOKEN }}"
          chat_id = "5679555666"
          url = "https://proxy.yuanquanke.cn/https/api.telegram.org/bot" + token + "/sendMessage"

          data = {
              "chat_id": chat_id,
              "text": message,
              "parse_mode": "Markdown"
          }
          encoded_data = json.dumps(data).encode("utf-8")

          try:
              req = urllib.request.Request(url, data=encoded_data, method="POST")
              req.add_header("Content-Type", "application/json")
              with urllib.request.urlopen(req) as response:
                  result = json.loads(response.read().decode("utf-8"))
                  print("Telegram é€šçŸ¥å·²å‘é€")
                  if not result.get("ok"):
                      print("APIè¿”å›é”™è¯¯:", result)
          except Exception as e:
              print(f"å‘é€ Telegram é€šçŸ¥å¤±è´¥: {e}")
              exit(1)
          '
