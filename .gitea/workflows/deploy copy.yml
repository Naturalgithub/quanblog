name: ä¸Šä¼ W3å­˜å‚¨æµ‹è¯•
on:
  push:
    branches:
      - main

# å®šä¹‰å·¥ä½œæµé˜¶æ®µ
jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åšå®¢
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç  - ä½¿ç”¨å†…ç½®çš„æ£€å‡ºæ“ä½œï¼Œä¸ä¾èµ–å¤–éƒ¨ actions
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…AWS CLI
        run: |
          echo "çœ‹æˆ‘è¡¨æ¼”å˜é‡ï¼š${{vars.ABC}}"
          echo "å®‰è£…AWS CLI..."
          apt-get update && apt-get install -y curl unzip
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" --connect-timeout 30 --retry 3 || echo "ä¸‹è½½å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          unzip -q awscliv2.zip || echo "è§£å‹å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          ./aws/install || echo "å®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          rm -rf awscliv2.zip aws
          which aws || echo "AWS CLIæœªæ‰¾åˆ°"
      - name: é…ç½®AWS
        run: |
          echo "é…ç½®AWSå‡­è¯..."
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set output json
          aws configure set default.s3.addressing_style path
          aws configure set default.s3.payload_signing_enabled true
      - name: å‡†å¤‡ä¸Šä¼ æ–‡ä»¶
        run: |
          echo "å‡†å¤‡ä¸Šä¼ æ–‡ä»¶..."
          mkdir -p docs/.vitepress/dist
          echo "Hello World from Gitea Actions çœ‹ 2025 å¹´ 7 æœˆ 7 æ—¥ 15:40:04" > docs/.vitepress/dist/index.html
          cat docs/.vitepress/dist/index.html
      - name: ä¸Šä¼ åˆ°S3
        run: |
          echo "ä¸Šä¼ åˆ°S3"
          aws s3 cp docs/.vitepress/dist/ s3://115-web/blog/ --recursive --endpoint-url http://home.yuanquanke.cn:35246

      # æ¸…ç†èµ„æº
      # - name: æ¸…ç†èµ„æº
      #   if: always() # æ— è®ºå‰é¢æ­¥éª¤æˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½æ‰§è¡Œæ¸…ç†
      #   run: |
      #     echo "æ¸…ç†èµ„æº..."
      #     rm -rf $WORKSPACE_DIR/docs/.vitepress/dist

      # éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success() # ä»…åœ¨æˆåŠŸæ—¶æ˜¾ç¤º
        run: |
          echo "âœ… åšå®¢å·²æˆåŠŸéƒ¨ç½²åˆ° W3 å­˜å‚¨ï¼"
          echo "ğŸ“Š éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: http://home.yuanquanke.cn:35246/115-web/blog/index.html"
